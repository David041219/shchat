<!DOCTYPE html>
<html>

<head>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>

  <title> CHATTY CHAT CHAT</title>
 <!-- <link rel='stylesheet' href='/stylesheets/style.css' />-->
  <script src='/javascripts/socket.io.js'></script>
  <style>
    html,
    body {
      height: 100%;
      padding: 0px;
      margin: 0px;
    }

    body {
      height: 100%;
      width: 100%;
      display: table;
    }

    #div1 {
      display: table-row;
      height: 10%;
      background-color: yellow;
      text-align: center;
    }

    #div2 {
      display: table-row;
      height: 90%;
      /*    background-color:blue;*/
      text-align: center;

    }

    #div3 {
      display: table-row;
  
      background-color: green;
    }

    #input_chat {
     border: none; position: absolute; top:0; left:0; outline: 3px solid orchid; width:100%;height:100%; font-size: 20px;
     padding-left: 5px;
    }
  </style>
  <script>
   $(window).bind("beforeunload",function(e){
    socket.emit('leaveRoom', roomname, id, "방 나가게 허락해줘");//방 나갈게
   });


   window.onresize = function (event) {

    $('#totalmsg').css({height:$('#totalmsg').parents().height()+'px'});
    $('#totalmsg').scrollTop($('#totalmsg')[0].scrollHeight);
    
   }
  </script>
</head>

<body>
  <div id="div1">

    <div style="font-size:20px;">세헌채팅방이에용</div>

  </div>

  <div id="div2">


    <div style="display:block; width:100%; height:100%; background-color:none;">


      <div style="width:100%; max-height: 90%; height:90%; background-color:white;     align-items: center;
      justify-content: center; display:flex;">
        <!--채팅프로그램 구역-->
        <div style="width:80%; height:80%; display:block;">
        <!--채팅 보는창-->  
          <div style="display:flex; height:90%; width: 100%; ">
            <div style="display:inline-block; background-color:green; height:100%; width:80%;">

              <div id="totalmsg" style="overflow-y:auto;width: 100%; height:300px;
               text-align:left; padding-left:10px; border: 1px solid blue;">
                


              </div>

            </div>
            <div id="member_list" style="display: inline-block; width: 20%; background-color: chocolate; ">
            </div>

          </div>

          <!--채팅 입력창-->
          <div style="display:flex; width:100%; height: 10%; ">

            <div style="background-color:red; width:20%;">
              <%=show_user%>
            </div>
            <div id='input_chat_wrapper' style="position: relative; background-color:blue; width:80%; height:100%;  ">
              <input id="input_chat" type="text" value="">
            </div>
          </div>
          
        </div>
         <!--채팅프로그램 끝--> 
      </div>




      <div style="width:100%; height:10%; background-color:red;">
        <!--

        -->
      </div>

    </div>
  </div>

  <!--div2-->

  <div id="div3">
  
  </div>








  <script>
    var id = '<%=show_user%>';
    var roomname = "a1"; //방이름
    var socket = io(window.location.origin);//백앤드소켓주소입력

    window.onload = function () {
      //console.log(socket);
   $('#totalmsg').css({height:$('#totalmsg').parents().height()+'px'});
//$('#totalmsg').css({height:'600px'});
      console.log("document ready");
      socket.emit('joinRoom', roomname, id, "방 들어가게 허락해줘");//방 들어갈게


      ///프론트에서 백앤드로 입장보내는메시지

      $('#input_chat').keypress(function (e) {
        if (e.key == 'Enter') {
          var getmsg = $('#input_chat').val();
          //alert(getmsg);
          $('#input_chat').val("");
          socket.emit('sendmsg_backend', roomname, id, getmsg);//방 들어갈게

        }

      });
      //프론트에서 백엔드로보내는 채팅메세지

      console.log("asfsaf" + window.location.origin);

      //var socket = io("http://34.85.15.240:8989");




      //백앤드에서 프론트로 보낸 메시지를 받는곳
      socket.on('joinRoom', (roomname, id, msg) => {
        console.log(msg);
        $('#totalmsg').append('<div>' + msg + '</div>');
        $('#totalmsg').scrollTop($('#totalmsg')[0].scrollHeight);
      });










      
      socket.on('add_member', (roomname, idlist) => {
        console.log("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
        console.log(idlist);
        $('#member_list').empty();
        for(var i=0; i<idlist.length; i++)
        {
          $('#member_list').append('<div>' + idlist[i] + '</div>');
        }


        /*
        console.log("멤버리스트: " + member_list);
        if (member_list.length >= 1) {
          const idx = member_list.indexOf(id);

          console.log("아아" + idx);

          if (idx > -1) {
            //이미있는정보니까 추가안함
            console.log("이미 맴버로 있기때문에 추가 안할게 아이디는:" + id);
          }
          else {

            console.log("맴버로 없기때문에 추가 할게 아이디는:" + id);
            member_list.push(id);
            $('#member_list').append('<div>' + id + '</div>');
            //없는정보니까 추가를 함
          }
        }
        else {
          console.log("맴버로 없기때문에 추가 할게 아이디는:" + id);

          member_list.push(id);

          $('#member_list').append('<div>' + id + '</div>');

        }
        */

      });




      
      socket.on('leaveRoom', (roomname, id, msg) => {
        console.log(msg);
        $('#totalmsg').append('<div>' + msg + '</div>');
        $('#totalmsg').scrollTop($('#totalmsg')[0].scrollHeight);

      });

      socket.on('sendmsg_frontend', (roomname, id, msg) => {
        console.log(msg);
        $('#totalmsg').append('<div>' + id + ": " + msg + '</div>');
        $('#totalmsg').scrollTop($('#totalmsg')[0].scrollHeight);
      });
    }
    var member_list = [];
  </script>
</body>




</html>